System.register("index",[],function(t,e){"use strict";var r;e&&e.id;return{setters:[],execute:function(){var e;(e=r=r||{}).boolean="booleantype",e.integer="integertype",e.string="stringtype",e.name="nametype",e.call="calltype",e.operator="operatortype",e.mark="marktype",e.array="arraytype",e.dict="dicttype",e.proc="proctype",t("ValueType",r)}}}),System.register("state/parser",["index"],function(e,t){"use strict";var u;t&&t.id;return e("parse",function*(e,t){var r=/%[^\n]*|(?:"([^"]*)")|\s+|((?:-|\+)?\d+)|\/(\S+)|(\[|\]|{|}|[^[\]{}}\s]+)/g;let n=r.exec(e);for(;null!==n;){var[,s,a,o,i]=n,c={type:u.ValueType.integer,data:0,source:e,sourcePos:n.index};void 0!==t&&(c.sourceFile=t),void 0!==s?yield{...c,type:u.ValueType.string,data:s}:void 0!==a?yield{...c,type:u.ValueType.integer,data:parseInt(a,10)}:void 0!==o?yield{...c,type:u.ValueType.name,data:o}:void 0!==i&&(yield{...c,type:u.ValueType.call,data:i}),n=r.exec(e)}}),{setters:[function(e){u=e}],execute:function(){}}}),System.register("errors/BaseError",[],function(e,t){"use strict";var r;t&&t.id;return{setters:[],execute:function(){r=class extends Error{constructor(e){super(e),this._callstack="",this.name=this.constructor.name}get callstack(){return""!==this._callstack?this._callstack:this.stack?.split("\n").slice(1).join("\n")??""}set callstack(e){""===this._callstack&&(this._callstack=e)}},e("BaseError",r)}}}),System.register("errors/Break",["errors/BaseError"],function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n=class extends r.BaseError{constructor(){super("break")}},e("Break",n)}}}),System.register("errors/BusyParsing",["errors/BaseError"],function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n=class extends r.BaseError{constructor(){super("The engine is already parsing a source")}},e("BusyParsing",n)}}}),System.register("errors/DictStackUnderflow",["errors/BaseError"],function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n=class extends r.BaseError{constructor(){super("An attempt has been made to remove (end) the bottommost instance of userdict from the dictionary stack but no corresponding add (begin) exists")}},e("DictStackUnderflow",n)}}}),System.register("errors/Internal",["errors/BaseError"],function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n=class extends r.BaseError{set callstack(e){}},e("Internal",n)}}}),System.register("errors/InvalidAccess",["errors/BaseError"],function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n=class extends r.BaseError{constructor(){super("access attribute violated (e.g. attempted to write a read-only object)")}},e("InvalidAccess",n)}}}),System.register("errors/InvalidBreak",["errors/BaseError"],function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n=class extends r.BaseError{constructor(){super("a break has been invoked for which there is no dynamically enclosing looping context")}},e("InvalidBreak",n)}}}),System.register("errors/RangeCheck",["errors/BaseError"],function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n=class extends r.BaseError{constructor(){super("operand is too big or too small")}},e("RangeCheck",n)}}}),System.register("errors/StackUnderflow",["errors/BaseError"],function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n=class extends r.BaseError{constructor(){super("you tried to pop from an empty stack")}},e("StackUnderflow",n)}}}),System.register("errors/TypeCheck",["errors/BaseError"],function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n=class extends r.BaseError{constructor(){super("operand is of the wrong type")}},e("TypeCheck",n)}}}),System.register("errors/Undefined",["errors/BaseError"],function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n=class extends r.BaseError{constructor(){super("name is not defined in any dictionary on the stack")}},e("Undefined",n)}}}),System.register("errors/UnmatchedMark",["errors/BaseError"],function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n=class extends r.BaseError{constructor(){super("mark object was not found in the stack")}},e("UnmatchedMark",n)}}}),System.register("errors/VMerror",["errors/BaseError"],function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n=class extends r.BaseError{constructor(){super("virtual memory full")}},e("VMError",n)}}}),System.register("errors/index",["errors/Break","errors/BusyParsing","errors/DictStackUnderflow","errors/Internal","errors/InvalidAccess","errors/InvalidBreak","errors/RangeCheck","errors/StackUnderflow","errors/TypeCheck","errors/Undefined","errors/UnmatchedMark","errors/VMerror"],function(n,e){"use strict";e&&e.id;function t(e){var t,r={};for(t in e)"default"!==t&&(r[t]=e[t]);n(r)}return{setters:[function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)}],execute:function(){}}}),System.register("objects/ShareableObject",[],function(e,t){"use strict";var r;t&&t.id;return{setters:[],execute:function(){e("ShareableObject",r=class r{static addRef(e){Array.isArray(e)?e.forEach(e=>{e.data instanceof r&&e.data.addRef()}):e.data instanceof r&&e.data.addRef()}static release(e){Array.isArray(e)?e.forEach(e=>{e.data instanceof r&&e.data.release()}):e.data instanceof r&&e.data.release()}constructor(){this._refCount=1}get refCount(){return this._refCount}addRef(){++this._refCount}release(){0==--this._refCount&&this._dispose()}})}}}),System.register("state/MemoryTracker",["index","errors/index"],function(e,t){"use strict";var r,n,s,a;t&&t.id;function o(e){return[r.ValueType.string,r.ValueType.name,r.ValueType.call].includes(e.type)}function i(e){return[r.ValueType.array,r.ValueType.proc,r.ValueType.dict].includes(e.type)}return{setters:[function(e){r=e},function(e){n=e}],execute:function(){s=e=>{return(new TextEncoder).encode(e).length+1},(a=class a{_addStringRef(e){var t,e=e.data,r=s(e);return e.length>=a.CACHABLE_STRING_LENGTH?-1===(t=this._strings.indexOf(e))?(this._strings.push(e),this._stringsRefCount.push(1),r+a.INTEGER_SIZE):(++this._stringsRefCount[t],0):r}_releaseString(e){var e=e.data,t=s(e);return e.length>=a.CACHABLE_STRING_LENGTH?(e=this._strings.indexOf(e),0==--this._stringsRefCount[e]?t+a.INTEGER_SIZE:0):t}constructor(e=1/0){this._total=e,this._used=0,this._strings=[],this._stringsRefCount=[]}get used(){return this._used}get total(){return this._total}addValueRef(e){let t=a.VALUE_SIZE;!0!==e.untracked&&(o(e)?t+=this._addStringRef(e):i(e)&&e.data.addRef()),this.increment(t)}releaseValue(e){let t=a.VALUE_SIZE;!0!==e.untracked&&(o(e)?t+=this._releaseString(e):i(e)&&e.data.release()),this.decrement(t)}increment(e){if(this._used+=e,this._used>this._total)throw new n.VMError}decrement(e){this._used-=e}}).POINTER_SIZE=4,a.INTEGER_SIZE=4,a.VALUE_TYPE_SIZE=1,a.VALUE_SIZE=a.VALUE_TYPE_SIZE+a.POINTER_SIZE,a.CACHABLE_STRING_LENGTH=32,e("MemoryTracker",a)}}}),System.register("objects/BaseArray",["objects/ShareableObject","state/MemoryTracker","errors/index"],function(e,t){"use strict";var r,n,s,a;t&&t.id;return{setters:[function(e){r=e},function(e){n=e},function(e){s=e}],execute:function(){(a=class a extends r.ShareableObject{constructor(e){super(),this._memoryTracker=e,this._values=[],this._memoryTracker.increment(a.INITIAL_SIZE)}get length(){return this._values.length}at(e){e=this._values[e];if(void 0===e)throw new s.RangeCheck;return Object.assign({},e)}addValueRef(e){this._memoryTracker.addValueRef(e),this._memoryTracker.increment(a.VALUE_ADDITIONAL_SIZE)}push(e){this.addValueRef(e),this.pushImpl(e)}releaseValue(e){this._memoryTracker.releaseValue(e),this._memoryTracker.decrement(a.VALUE_ADDITIONAL_SIZE)}pop(){if(0===this._values.length)throw new s.StackUnderflow;var e=this.popImpl();this.releaseValue(e)}get ref(){return this._values}_dispose(){for(;0<this._values.length;)this.pop();this._memoryTracker.decrement(a.INITIAL_SIZE)}}).INITIAL_SIZE=n.MemoryTracker.POINTER_SIZE,a.VALUE_ADDITIONAL_SIZE=n.MemoryTracker.POINTER_SIZE,e("BaseArray",a)}}}),System.register("objects/Stack",["objects/BaseArray"],function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n=class extends r.BaseArray{pushImpl(e){this._values.unshift(e)}popImpl(){return this._values.shift()}},e("Stack",n)}}}),System.register("objects/dictionaries/types",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("objects/dictionaries/Dictionary",["index","state/MemoryTracker","objects/ShareableObject"],function(e,t){"use strict";var n,r,s,a;t&&t.id;return{setters:[function(e){n=e},function(e){r=e},function(e){s=e}],execute:function(){(a=class a extends s.ShareableObject{constructor(e){super(),this._memoryTracker=e,this._values={},this._memoryTracker.increment(a.INITIAL_SIZE)}get names(){return Object.keys(this._values)}lookup(e){e=this._values[e];return void 0===e?null:e}def(e,t){var r=this._values[e];void 0!==r?this._memoryTracker.releaseValue(r):(this._memoryTracker.addValueRef({type:n.ValueType.string,data:e}),this._memoryTracker.increment(a.VALUE_ADDITIONAL_SIZE)),this._memoryTracker.addValueRef(t),this._values[e]=t}_dispose(){this.names.forEach(e=>{var t=this._values[e];this._memoryTracker.releaseValue(t),this._memoryTracker.releaseValue({type:n.ValueType.string,data:e}),this._memoryTracker.decrement(a.VALUE_ADDITIONAL_SIZE)}),this._memoryTracker.decrement(a.INITIAL_SIZE)}}).INITIAL_SIZE=r.MemoryTracker.POINTER_SIZE,a.VALUE_ADDITIONAL_SIZE=3*r.MemoryTracker.POINTER_SIZE,e("Dictionary",a)}}}),System.register("objects/dictionaries/Host",["objects/ShareableObject","errors/index"],function(e,t){"use strict";var r,n,s;t&&t.id;return{setters:[function(e){r=e},function(e){n=e}],execute:function(){s=class extends r.ShareableObject{get names(){return this._hostDictionary.names}lookup(e){return this._hostDictionary.lookup(e)}def(e,t){throw new n.InvalidAccess}constructor(e){super(),this._hostDictionary=e}_dispose(){}},e("HostDictionary",s)}}}),System.register("operators/operands",["index","errors/index"],function(e,t){"use strict";var r,n;t&&t.id;return e("checkOperands",function(e,...t){const r=e.operandsRef;if(t.length>r.length)throw new n.StackUnderflow;return t.map((e,t)=>{t=r[t];if(null!==e&&t.type!==e)throw new n.TypeCheck;return t})}),e("findMarkPos",function(e){if(-1===(e=e.operandsRef.findIndex(e=>e.type===r.ValueType.mark)))throw new n.UnmatchedMark;return e}),{setters:[function(e){r=e},function(e){n=e}],execute:function(){}}}),System.register("operators/add",["index","operators/operands"],function(e,t){"use strict";var n,s;t&&t.id;return e("add",function*(e){var[t,r]=s.checkOperands(e,n.ValueType.integer,n.ValueType.integer).map(e=>e.data);e.pop(),e.pop(),e.push({type:n.ValueType.integer,data:t+r})}),{setters:[function(e){n=e},function(e){s=e}],execute:function(){}}}),System.register("objects/Array",["errors/index","objects/BaseArray"],function(e,t){"use strict";var n,r,s;t&&t.id;return{setters:[function(e){n=e},function(e){r=e}],execute:function(){s=class extends r.BaseArray{pushImpl(e){this._values.push(e)}popImpl(){var e=this._values.at(-1);return this._values.pop(),e}shift(){var e=this._values.shift();if(void 0===e)throw new n.Internal("array is empty");return this.releaseValue(e),e}unshift(e){this.addValueRef(e),this._values.unshift(e)}set(e,t){if(e<0)throw new n.RangeCheck;var r=this._values[e];this.addValueRef(t),void 0!==r&&this.releaseValue(r),this._values[e]=t}},e("ArrayLike",s)}}}),System.register("operators/aload",["index","operators/operands","errors/index"],function(e,t){"use strict";var o,i,c;t&&t.id;return e("aload",function*(t){var[{type:e,data:r}]=i.checkOperands(t,null);if(![o.ValueType.array,o.ValueType.proc].includes(e))throw new c.TypeCheck;var n=r,s=n["length"];n.addRef();try{t.pop();for(let e=0;e<s;++e){var a=n.at(e);t.push(a)}}finally{n.release()}}),{setters:[function(e){o=e},function(e){i=e},function(e){c=e}],execute:function(){}}}),System.register("operators/begin",["index","operators/operands"],function(e,t){"use strict";var r,n;t&&t.id;return e("begin",function*(e){var[t]=n.checkOperands(e,r.ValueType.dict);e.begin(t.data),e.pop()}),{setters:[function(e){r=e},function(e){n=e}],execute:function(){}}}),System.register("operators/bind",["index","errors/index","operators/operands"],function(e,t){"use strict";var i,c,u;t&&t.id;return e("bind",function*(t){var[e]=u.checkOperands(t,i.ValueType.proc),r=[e.data];let n=0;for(;n<r.length;){var s=r[n];for(let e=0;e<s.ref.length;++e){var a=s.at(e);if(a.type===i.ValueType.call){yield;try{var o=t.lookup(a.data);s.set(e,{...a,...o})}catch(e){if(!(e instanceof c.Undefined))throw e}}else a.type===i.ValueType.proc&&r.push(a.data)}++n}}),{setters:[function(e){i=e},function(e){c=e},function(e){u=e}],execute:function(){}}}),System.register("operators/clear",[],function(e,t){"use strict";t&&t.id;return e("clear",function*(e){for(var t=e.operandsRef;0<t.length;)e.pop()}),{setters:[],execute:function(){}}}),System.register("operators/cleartomark",["operators/operands"],function(e,t){"use strict";var r;t&&t.id;return e("cleartomark",function*(e){let t=r.findMarkPos(e);for(;0<=t;)e.pop(),--t}),{setters:[function(e){r=e}],execute:function(){}}}),System.register("operators/open-close-helper",["index","objects/Array","operators/operands"],function(e,t){"use strict";var r,i,c;t&&t.id;return e("openWithMark",function(e){var t=e.callsRef[0];e.push({...t,type:r.ValueType.mark,data:null})}),e("closeToMark",function(t,r){var n=c.findMarkPos(t),s=t.operandsRef[n],a=t.operandsRef,o=new i.ArrayLike(t.memoryTracker);try{let e;for(e=0;e<n;++e)o.unshift(a[e]);for(e=0;e<=n;++e)t.pop();t.push({...s,type:r,data:o})}finally{o.release()}}),{setters:[function(e){r=e},function(e){i=e},function(e){c=e}],execute:function(){}}}),System.register("operators/close-array",["index","operators/open-close-helper"],function(e,t){"use strict";var r,n;t&&t.id;function*s(e){n.closeToMark(e,r.ValueType.array)}return e("closeArray",s),{setters:[function(e){r=e},function(e){n=e}],execute:function(){Object.defineProperty(s,"name",{value:"]",writable:!1})}}}),System.register("operators/close-proc",["index","operators/open-close-helper"],function(e,t){"use strict";var r,n;t&&t.id;function*s(e){n.closeToMark(e,r.ValueType.proc),e.allowCall()}return e("closeProc",s),{setters:[function(e){r=e},function(e){n=e}],execute:function(){Object.defineProperty(s,"name",{value:"}",writable:!1})}}}),System.register("operators/count",["index"],function(e,t){"use strict";var r;t&&t.id;return e("count",function*(e){e.push({type:r.ValueType.integer,data:e.operandsRef.length})}),{setters:[function(e){r=e}],execute:function(){}}}),System.register("operators/counttomark",["index","operators/operands"],function(e,t){"use strict";var r,n;t&&t.id;return e("counttomark",function*(e){var t=n.findMarkPos(e);e.push({type:r.ValueType.integer,data:t})}),{setters:[function(e){r=e},function(e){n=e}],execute:function(){}}}),System.register("operators/currentdict",[],function(e,t){"use strict";t&&t.id;return e("currentdict",function*(e){e.push(e.dictionariesRef[0])}),{setters:[],execute:function(){}}}),System.register("operators/def",["index","operators/operands"],function(e,t){"use strict";var s,a;t&&t.id;return e("def",function*(e){var[t,r]=a.checkOperands(e,null,s.ValueType.name),[{data:n}]=e.dictionariesRef;n.def(r.data,t),e.pop(),e.pop()}),{setters:[function(e){s=e},function(e){a=e}],execute:function(){}}}),System.register("operators/dict",["index","objects/dictionaries/index"],function(e,t){"use strict";var r,n;t&&t.id;return e("dict",function*(e){var t=new n.Dictionary(e.memoryTracker);e.push({type:r.ValueType.dict,data:t}),t.release()}),{setters:[function(e){r=e},function(e){n=e}],execute:function(){}}}),System.register("operators/dictstack",["objects/Array","index"],function(e,t){"use strict";var s,a;t&&t.id;return e("dictstack",function*(e){var t=new s.ArrayLike(e.memoryTracker),r=e.dictionariesRef;try{for(const n of r)t.push(n);e.push({type:a.ValueType.array,data:t})}finally{t.release()}}),{setters:[function(e){s=e},function(e){a=e}],execute:function(){}}}),System.register("operators/end",[],function(e,t){"use strict";t&&t.id;return e("end",function*(e){e.end()}),{setters:[],execute:function(){}}}),System.register("operators/eq",["index","operators/operands"],function(e,t){"use strict";var n,s;t&&t.id;return e("eq",function*(e){var[t,r]=s.checkOperands(e,null,null),t=t.type===r.type&&t.data===r.data;e.pop(),e.pop(),e.push({type:n.ValueType.boolean,data:t})}),{setters:[function(e){n=e},function(e){s=e}],execute:function(){}}}),System.register("operators/exch",["operators/operands","objects/ShareableObject"],function(e,t){"use strict";var n,s;t&&t.id;return e("exch",function*(e){var[t,r]=n.checkOperands(e,null,null);s.ShareableObject.addRef([t,r]);try{e.pop(),e.pop(),e.push(t),e.push(r)}finally{s.ShareableObject.release([t,r])}}),{setters:[function(e){n=e},function(e){s=e}],execute:function(){}}}),System.register("operators/dup",["operators/operands"],function(e,t){"use strict";var r;t&&t.id;return e("dup",function*(e){var[t]=r.checkOperands(e,null);e.push(t)}),{setters:[function(e){r=e}],execute:function(){}}}),System.register("operators/false",["index"],function(e,t){"use strict";var r;t&&t.id;function*n(e){e.push({type:r.ValueType.boolean,data:!1})}return e("falseOp",n),{setters:[function(e){r=e}],execute:function(){Object.defineProperty(n,"name",{value:"false",writable:!1})}}}),System.register("operators/get",["index","errors/index","operators/operands","objects/ShareableObject"],function(e,t){"use strict";var r,s,a,o,i;t&&t.id;function n(e){var[e,t]=e.operandsRef;if(e.type!==r.ValueType.integer)throw new s.TypeCheck;e=e.data;return t.data.at(e)}return e("get",function*(e){var[,t]=a.checkOperands(e,null,null),r=i[t.type];if(void 0===r)throw new s.TypeCheck;o.ShareableObject.addRef(t);try{var n=r(e);e.pop(),e.pop(),e.push(n)}finally{o.ShareableObject.release(t)}}),{setters:[function(e){r=e},function(e){s=e},function(e){a=e},function(e){o=e}],execute:function(){i={[r.ValueType.string]:e=>{var[e,t]=e.operandsRef;if(e.type!==r.ValueType.integer)throw new s.TypeCheck;e=e.data,t=t.data;if(e<0||e>=t.length)throw new s.RangeCheck;return{type:r.ValueType.integer,data:t.charCodeAt(e)}},[r.ValueType.array]:n,[r.ValueType.dict]:e=>{var[e,t]=e.operandsRef;if(e.type!==r.ValueType.name)throw new s.TypeCheck;e=e.data,t=t.data.lookup(e);if(null===t)throw new s.Undefined;return t},[r.ValueType.proc]:n}}}}),System.register("operators/globaldict",["index"],function(e,t){"use strict";var r;t&&t.id;return e("globaldict",function*(e){e.push({type:r.ValueType.dict,data:e.globaldict})}),{setters:[function(e){r=e}],execute:function(){}}}),System.register("operators/if",["index","operators/operands","objects/ShareableObject"],function(e,t){"use strict";var n,s,a;t&&t.id;function*r(e){var[t,r]=s.checkOperands(e,n.ValueType.proc,n.ValueType.boolean);a.ShareableObject.addRef(t);try{e.pop(),e.pop(),r.data&&(yield*e.eval(t))}finally{a.ShareableObject.release(t)}}return e("ifOp",r),{setters:[function(e){n=e},function(e){s=e},function(e){a=e}],execute:function(){Object.defineProperty(r,"name",{value:"if",writable:!1})}}}),System.register("operators/ifelse",["index","operators/operands","objects/ShareableObject"],function(e,t){"use strict";var s,a,o;t&&t.id;return e("ifelse",function*(e){var[t,r,n]=a.checkOperands(e,s.ValueType.proc,s.ValueType.proc,s.ValueType.boolean);o.ShareableObject.addRef([r,t]);try{e.pop(),e.pop(),e.pop(),n.data?yield*e.eval(r):yield*e.eval(t)}finally{o.ShareableObject.release([r,t])}}),{setters:[function(e){s=e},function(e){a=e},function(e){o=e}],execute:function(){}}}),System.register("operators/index-op",["operators/operands","index","errors/index"],function(e,t){"use strict";var n,s,a;t&&t.id;return e("index",function*(e){var[t]=n.checkOperands(e,s.ValueType.integer).map(e=>e.data);if(t<0)throw new a.RangeCheck;var r=e.operandsRef;if(t+1>=r.length)throw new a.StackUnderflow;e.pop(),r=r[t],e.push(r)}),{setters:[function(e){n=e},function(e){s=e},function(e){a=e}],execute:function(){}}}),System.register("operators/length",["index","errors/index","operators/operands","objects/ShareableObject"],function(e,t){"use strict";var s,a,o,i,c;t&&t.id;function r(e){return e.data.length}return e("length",function*(e){var[t]=o.checkOperands(e,null),r=c[t.type];if(void 0===r)throw new a.TypeCheck;i.ShareableObject.addRef(t);try{var n=r(t);e.pop(),e.push({type:s.ValueType.integer,data:n})}finally{i.ShareableObject.release(t)}}),{setters:[function(e){s=e},function(e){a=e},function(e){o=e},function(e){i=e}],execute:function(){c={[s.ValueType.string]:e=>{return e.data.length},[s.ValueType.array]:r,[s.ValueType.dict]:e=>{return e.data.names.length},[s.ValueType.proc]:r}}}}),System.register("operators/loop",["index","errors/index","objects/ShareableObject","operators/operands"],function(e,t){"use strict";var r,n,s,a;t&&t.id;function*o(e){var[t]=a.checkOperands(e,r.ValueType.proc);s.ShareableObject.addRef(t);try{for(e.pop();;)yield*e.eval(t)}catch(e){if(!(e instanceof n.Break))throw e}finally{s.ShareableObject.release(t)}}return e("loop",o),{setters:[function(e){r=e},function(e){n=e},function(e){s=e},function(e){a=e}],execute:function(){Object.defineProperty(o,"breakable",{value:!0,writable:!1})}}}),System.register("operators/mark",["index"],function(e,t){"use strict";var r;t&&t.id;return e("mark",function*(e){e.push({type:r.ValueType.mark,data:null})}),{setters:[function(e){r=e}],execute:function(){}}}),System.register("operators/neq",["index","operators/operands"],function(e,t){"use strict";var n,s;t&&t.id;return e("neq",function*(e){var[t,r]=s.checkOperands(e,null,null),t=t.type!==r.type||t.data!==r.data;e.pop(),e.pop(),e.push({type:n.ValueType.boolean,data:t})}),{setters:[function(e){n=e},function(e){s=e}],execute:function(){}}}),System.register("operators/open-array",["operators/open-close-helper"],function(e,t){"use strict";var r;t&&t.id;function*n(e){r.openWithMark(e)}return e("openArray",n),{setters:[function(e){r=e}],execute:function(){Object.defineProperty(n,"name",{value:"[",writable:!1})}}}),System.register("operators/open-proc",["operators/open-close-helper"],function(e,t){"use strict";var r;t&&t.id;function*n(e){r.openWithMark(e),e.preventCall()}return e("openProc",n),{setters:[function(e){r=e}],execute:function(){Object.defineProperty(n,"name",{value:"{",writable:!1})}}}),System.register("operators/pop",["operators/operands"],function(e,t){"use strict";var r;t&&t.id;return e("pop",function*(e){r.checkOperands(e,null),e.pop()}),{setters:[function(e){r=e}],execute:function(){}}}),System.register("operators/roll",["index","operators/operands","objects/ShareableObject","errors/index"],function(e,t){"use strict";var a,o,i,c;t&&t.id;return e("roll",function*(t){var[r,n]=o.checkOperands(t,a.ValueType.integer,a.ValueType.integer).map(e=>e.data);if(t.operandsRef.length<n+2)throw new c.StackUnderflow;var s=t.operandsRef.slice(2,2+n).reverse();i.ShareableObject.addRef(s);try{t.pop(),t.pop();let e;for(e=0;e<n;++e)t.pop();for(e=0;e<n;++e)t.push(s[(n+e-r)%n])}finally{i.ShareableObject.release(s)}}),{setters:[function(e){a=e},function(e){o=e},function(e){i=e},function(e){c=e}],execute:function(){}}}),System.register("operators/set",["index","errors/index","operators/operands","objects/ShareableObject"],function(e,t){"use strict";var s,a,o,i,c;t&&t.id;return e("set",function*(e){var[,,t]=o.checkOperands(e,null,null,null),r=c[t.type];if(void 0===r)throw new a.TypeCheck;i.ShareableObject.addRef(t);try{var n=r(e);e.pop(),e.pop(),e.pop(),e.push(n)}finally{i.ShareableObject.release(t)}}),{setters:[function(e){s=e},function(e){a=e},function(e){o=e},function(e){i=e}],execute:function(){c={[s.ValueType.string]:e=>{var[e,t,r]=e.operandsRef;if(t.type!==s.ValueType.integer||e.type!==s.ValueType.integer)throw new a.TypeCheck;t=t.data,r=r.data;if(t<0||t>=r.length)throw new a.RangeCheck;var n=[];return 0<t&&n.push(r.substring(0,t)),n.push(String.fromCharCode(e.data)),t+1<r.length&&n.push(r.substring(t+1)),{type:s.ValueType.string,data:n.join("")}},[s.ValueType.array]:e=>{var[e,t,r]=e.operandsRef;if(t.type!==s.ValueType.integer)throw new a.TypeCheck;var t=t.data,n=r.data;if(t>=n.length)throw new a.RangeCheck;return n.set(t,e),r},[s.ValueType.dict]:e=>{var[e,t,r]=e.operandsRef;if(t.type!==s.ValueType.name)throw new a.TypeCheck;t=t.data;return r.data.def(t,e),r}}}}}),System.register("operators/sub",["index","operators/operands"],function(e,t){"use strict";var n,s;t&&t.id;return e("sub",function*(e){var[t,r]=s.checkOperands(e,n.ValueType.integer,n.ValueType.integer).map(e=>e.data);e.pop(),e.pop(),e.push({type:n.ValueType.integer,data:r-t})}),{setters:[function(e){n=e},function(e){s=e}],execute:function(){}}}),System.register("operators/systemdict",["index"],function(e,t){"use strict";var r;t&&t.id;return e("systemdict",function*(e){e.push({type:r.ValueType.dict,data:e.systemdict})}),{setters:[function(e){r=e}],execute:function(){}}}),System.register("operators/true",["index"],function(e,t){"use strict";var r;t&&t.id;function*n(e){e.push({type:r.ValueType.boolean,data:!0})}return e("trueOp",n),{setters:[function(e){r=e}],execute:function(){Object.defineProperty(n,"name",{value:"true",writable:!1})}}}),System.register("operators/type",["index","operators/operands"],function(e,t){"use strict";var r,n;t&&t.id;return e("type",function*(e){var[{type:t}]=n.checkOperands(e,null);e.pop(),e.push({type:r.ValueType.string,data:t})}),{setters:[function(e){r=e},function(e){n=e}],execute:function(){}}}),System.register("operators/index",["operators/add","operators/aload","operators/begin","operators/bind","operators/clear","operators/cleartomark","operators/close-array","operators/close-proc","operators/count","operators/counttomark","operators/currentdict","operators/def","operators/dict","operators/dictstack","operators/end","operators/eq","operators/exch","operators/dup","operators/false","operators/get","operators/globaldict","operators/if","operators/ifelse","operators/index-op","operators/length","operators/loop","operators/mark","operators/neq","operators/open-array","operators/open-proc","operators/pop","operators/roll","operators/set","operators/sub","operators/systemdict","operators/true","operators/type"],function(n,e){"use strict";e&&e.id;function t(e){var t,r={};for(t in e)"default"!==t&&(r[t]=e[t]);n(r)}return{setters:[function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)}],execute:function(){}}}),System.register("operators/errors",["errors/index"],function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n={},Object.values(r).forEach(e=>{if(!["Internal","BusyParsing"].includes(e.name)){const r=e;var t=function*(e){throw new r};Object.defineProperty(t,"name",{value:e.name.toLowerCase(),writable:!1}),n[t.name]=t}}),e("default",n)}}}),System.register("objects/dictionaries/System",["index","objects/ShareableObject","errors/index","operators/index","operators/errors"],function(e,t){"use strict";var r,n,s,a,o,i,c;t&&t.id;return{setters:[function(e){r=e},function(e){n=e},function(e){s=e},function(e){a=e},function(e){o=e}],execute:function(){i={},Object.values(a).forEach(e=>{i[e.name]=e}),Object.values(o.default).forEach(e=>{i[e.name]=e}),c=class extends n.ShareableObject{get names(){return Object.keys(i)}lookup(e){e=i[e];return void 0===e?null:{type:r.ValueType.operator,data:e}}def(e,t){throw new s.InvalidAccess}_dispose(){}},e("SystemDictionary",c)}}}),System.register("objects/dictionaries/index",["objects/dictionaries/Dictionary","objects/dictionaries/Host","objects/dictionaries/System","objects/dictionaries/types"],function(n,e){"use strict";e&&e.id;function t(e){var t,r={};for(t in e)"default"!==t&&(r[t]=e[t]);n(r)}return{setters:[function(e){t(e)},function(e){t(e)},function(e){t(e)},function(e){t(e)}],execute:function(){}}}),System.register("formatters",["index","objects/dictionaries/index"],function(e,t){"use strict";var r,n,a;t&&t.id;return{setters:[function(e){r=e},function(e){n=e}],execute:function(){e("formatters",a={[r.ValueType.boolean]:e=>e.data?"true":"false",[r.ValueType.integer]:e=>e.data.toString(),[r.ValueType.string]:e=>JSON.stringify(e.data),[r.ValueType.name]:e=>"/"+e.data,[r.ValueType.call]:e=>e.data,[r.ValueType.operator]:e=>`-${e.data.name}-`,[r.ValueType.mark]:e=>"--mark--",[r.ValueType.array]:e=>{var t=["["],r=e.data,n=r["length"];for(let e=0;e<n;++e){var s=r.at(e);t.push(a[s.type](s))}return t.push("]"),t.join(" ")},[r.ValueType.dict]:e=>{var t=e.data;return e.data instanceof n.HostDictionary?`--hostdict(${t.names.length.toString()})--`:e.data instanceof n.SystemDictionary?`--systemdict(${t.names.length.toString()})--`:`--dictionary(${t.names.length.toString()})--`},[r.ValueType.proc]:e=>{var t=["{"],r=e.data,n=r["length"];for(let e=0;e<n;++e){var s=r.at(e);t.push(a[s.type](s))}return t.push("}"),t.join(" ")}})}}}),System.register("state/callstack",["index","formatters","state/parser","errors/index"],function(e,t){"use strict";var c,o,a,i,r,u;t&&t.id;function l(e){return JSON.stringify(e.replace(/\r?\n/g,"\u21b5").replace(/\t/g,"\u2b72"))}return e("renderCallStack",function(t){var r=t["length"],n=[];let s;for(let e=0;e<r;++e){var a=t.at(e);if(a.type===c.ValueType.integer)s=a.data;else{let e="";var{sourceFile:o,sourcePos:i}=a,o=(void 0!==o&&void 0!==i&&(e=` @${o}:`+i.toString()),u[a.type](a,s));n.push(o+e),s=void 0}}return n.join("\n")}),{setters:[function(e){c=e},function(e){o=e},function(e){a=e},function(e){i=e}],execute:function(){r=e=>"/!\\ unexpected stack item type "+e.type,u={[c.ValueType.boolean]:r,[c.ValueType.integer]:r,[c.ValueType.string]:(e,t)=>{var r=e.data;if(void 0===t)return l(r);{var n=r.substring(0,t);const e=a.parse(r.substring(t)).next()["value"];if(void 0===e)throw new i.Internal("Unexpected parser failure");var s=o.formatters[e.type](e);return l(n+`\u00bb${s}\u00ab`+r.substring(t+s.length))}},[c.ValueType.name]:r,[c.ValueType.call]:e=>o.formatters[e.type](e),[c.ValueType.operator]:(e,t)=>{e=o.formatters[e.type](e);return void 0!==t?e+":"+t:e},[c.ValueType.mark]:r,[c.ValueType.array]:r,[c.ValueType.dict]:r,[c.ValueType.proc]:(e,t)=>{var r=["{"],n=e.data,s=n["length"];for(let e=0;e<s;++e){var a=n.at(e);t===e?r.push("\u00bb"+o.formatters[a.type](a)+"\u00ab"):r.push(o.formatters[a.type](a))}return r.push("}"),r.join(" ")}}}}}),System.register("state/State",["index","errors/index","state/index","objects/Stack","state/MemoryTracker","objects/dictionaries/index","objects/dictionaries/Host","errors/BaseError","state/callstack"],function(e,t){"use strict";var a,n,o,r,s,i,c,u,l,p;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){o=e},function(e){r=e},function(e){s=e},function(e){i=e},function(e){c=e},function(e){u=e},function(e){l=e}],execute:function(){e("State",p=class{constructor(e={}){this._systemdict=new i.SystemDictionary,this._keepDebugInfo=!1,this._noCall=0,this._memoryTracker=new s.MemoryTracker(e.maxMemoryBytes),this._dictionaries=new r.Stack(this._memoryTracker),this._globaldict=new i.Dictionary(this._memoryTracker),null!=e.hostDictionary&&this.begin(new c.HostDictionary(e.hostDictionary)),!0===e.keepDebugInfo&&(this._keepDebugInfo=!0),this.begin(this._systemdict),this.begin(this._globaldict),this._minDictCount=this._dictionaries.length,this._operands=new r.Stack(this._memoryTracker),this._calls=new r.Stack(this._memoryTracker)}get usedMemory(){return this._memoryTracker.used}get totalMemory(){return this._memoryTracker.total}get operands(){return this._operands}get dictionaries(){return this._dictionaries}get calls(){return this._calls}*parse(e,t){if(0!==this._calls.length)throw new n.BusyParsing;yield*this.innerParse(e,t)}get memoryTracker(){return this._memoryTracker}get keepDebugInfo(){return this._keepDebugInfo}get systemdict(){return this._systemdict}get globaldict(){return this._globaldict}get operandsRef(){return this._operands.ref}get callsRef(){return this._calls.ref}pop(){this._operands.pop()}push(e){this._operands.push(e)}get dictionariesRef(){return this._dictionaries.ref}lookup(e){for(const r of this._dictionaries.ref){var t=r.data.lookup(e);if(null!==t)return t}throw new n.Undefined}begin(e){this._dictionaries.push({type:a.ValueType.dict,data:e})}end(){if(this._dictionaries.ref.length===this._minDictCount)throw new n.DictStackUnderflow;this._dictionaries.pop()}preventCall(){++this._noCall}allowCall(){--this._noCall}*wrapCall(e,t){this._calls.push(e),yield;try{yield*t.apply(this)}catch(e){throw e instanceof u.BaseError&&(e.callstack=l.renderCallStack(this.calls)),e}finally{this._calls.pop()}}*evalCall(t){yield*this.wrapCall(t,function*(){let e=this.lookup(t.data);e.type===a.ValueType.operator&&this._keepDebugInfo&&(e={...t,...e}),yield*this.eval(e)})}*evalOperator(e){yield*this.wrapCall(e,function*(){yield*(0,e.data)(this)})}*evalProc(e){yield*this.wrapCall(e,function*(){var t=e.data,r=t["length"];for(let e=0;e<r;++e){this._calls.push({type:a.ValueType.integer,data:e});try{yield*this.evalWithoutProc(t.at(e))}finally{this._calls.pop()}}})}*evalWithoutProc(e){e.type!==a.ValueType.call||0!==this._noCall&&!["{","}"].includes(e.data)?e.type===a.ValueType.operator?yield*this.evalOperator(e):(yield,this.push(e)):yield*this.evalCall(e)}*eval(t){try{t.type===a.ValueType.proc&&0===this._noCall?yield*this.evalProc(t):yield*this.evalWithoutProc(t)}catch(e){if(e instanceof n.Break&&!this._calls.ref.some(({type:e,data:t})=>e===a.ValueType.operator&&!0===t.breakable))throw(t=new n.InvalidBreak).callstack=e.callstack,t;throw e}}*innerParse(e,s){yield*this.wrapCall({type:a.ValueType.string,data:e,untracked:!0,sourceFile:s,sourcePos:0},function*(){var t,r;for(const n of o.parse(e,s)){this._calls.push({type:a.ValueType.integer,data:n.sourcePos});try{yield;let e;e=this._keepDebugInfo?n:({type:t,data:r}=n,{type:t,data:r}),yield*this.eval(e)}finally{this._calls.pop()}}})}})}}}),System.register("state/types",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("state/index",["state/parser","state/State","state/types"],function(n,e){"use strict";e&&e.id;function t(e){var t,r={};for(t in e)"default"!==t&&(r[t]=e[t]);n(r)}return{setters:[function(e){t(e)},function(e){t(e)},function(e){t(e)}],execute:function(){}}}),System.register("factory",["state/index"],function(e,t){"use strict";var r;t&&t.id;return e("createState",function(e){return new r.State(e)}),{setters:[function(e){r=e}],execute:function(){}}}),System.register("iterators",[],function(e,t){"use strict";t&&t.id;return e("length",function(e){let t=0,r=e.next()["done"];for(;!1===r;)++t,r=e.next().done;return t}),{setters:[],execute:function(){}}}),System.register("utf8toansii",["node:fs/promises"],function(e,t){"use strict";var r;t&&t.id;return{setters:[function(e){r=e}],execute:function(){!async function(e){var t=(await r.readFile(e)).toString().replace(/[^\r\n\t -~]/g,e=>{return"\\u"+e.charCodeAt(0).toString(16).padStart(4,"0")});await r.writeFile(e,t)}(process.argv[2])}}}),System.register("repl/colors",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){e("red","\u270ered"),e("green","\u270egreen"),e("yellow","\u270eyellow"),e("blue","\u270eblue"),e("magenta","\u270emagenta"),e("cyan","\u270ecyan"),e("white","\u270ewhite")}}}),System.register("repl/forEach",["repl/colors"],function(e,t){"use strict";var o;t&&t.id;return e("forEach",function(t,r){var n=t["length"];let s=1;10<n&&++s,100<n&&++s;for(let e=0;e<n;++e){var a=""+o.blue+e.toString().padStart(s," ")+o.white;r(t.at(e),a)}}),{setters:[function(e){o=e}],execute:function(){}}}),System.register("repl/replHost",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("repl/signals",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){e("$state",Symbol("state")),e("$debug",Symbol("debug")),e("$load",Symbol("load"))}}}),System.register("repl/host/debug",["repl/signals"],function(e,t){"use strict";var r;t&&t.id;return e("debug",function*(e){yield r.$debug}),{setters:[function(e){r=e}],execute:function(){}}}),System.register("repl/host/exit",[],function(e,t){"use strict";var r;t&&t.id;return e("exit",function*(e){throw new r}),{setters:[],execute:function(){r=class extends Error{},e("ExitError",r)}}}),System.register("repl/host/load",["index","operators/operands","repl/signals"],function(e,t){"use strict";var n,s,a;t&&t.id;return e("load",function*(e){var[t]=s.checkOperands(e,n.ValueType.string).map(e=>e.data),r=yield a.$load;e.pop(),yield*e.innerParse(r,t)}),{setters:[function(e){n=e},function(e){s=e},function(e){a=e}],execute:function(){}}}),System.register("repl/host/state",["repl/signals"],function(e,t){"use strict";var r;t&&t.id;return e("state",function*(e){yield r.$state}),{setters:[function(e){r=e}],execute:function(){}}}),System.register("repl/host/index",["index","repl/host/debug","repl/host/exit","repl/host/load","repl/host/state"],function(e,t){"use strict";var r,n,s,a,o,i;t&&t.id;return{setters:[function(e){r=e},function(e){n=e},function(e){s=e},function(e){a=e},function(e){o=e}],execute:function(){i={debug:n.debug,exit:s.exit,load:a.load,state:o.state},e("hostDictionary",{get names(){return Object.keys(i)},lookup(e){e=i[e];return void 0===e?null:{type:r.ValueType.operator,data:e}}})}}}),System.register("repl/status",["repl/colors"],function(e,t){"use strict";var i,r;t&&t.id;function c(e){for(const t of r)if(e>t.factor)return""+(e/t.factor).toFixed(2)+t.unit;return e+"B"}function u(e){var{usedMemory:e,totalMemory:t}=e;return t===1/0?c(e)+i.blue+"/\u221e"+i.white:c(e)+i.blue+"/"+c(t)+i.white}return e("memory",u),e("status",function(e,t){let r,n=(r=t.absolute?"cycle: #":"cycles: ","");var s,a=t["lastOperandsCount"];void 0!==a&&(a<(s=e.operands.length)?n=` ${i.red}+`+(s-a):s<a&&(n=` ${i.red}-`+(a-s)));let o="";return void 0!==(a=t["lastUsedMemory"])&&(a<(s=e.usedMemory)?o=` ${i.red}+`+c(s-a):s<a&&(o=` ${i.green}-`+c(a-s))),[""+i.cyan+r+i.yellow+t.cycle,i.cyan+", operands: "+i.yellow+e.operands.length+n,i.cyan+", memory: "+i.yellow+u(e)+o,i.white,t.concat,i.white].join("")}),{setters:[function(e){i=e}],execute:function(){r=[{factor:1048576,unit:"MB"},{factor:1024,unit:"kB"}]}}}),System.register("repl/impl",["repl/colors","repl/host/index","factory","repl/host/exit","errors/BaseError","repl/status","repl/signals","state/callstack","repl/forEach","formatters"],function(e,t){"use strict";var h,r,n,s,a,m,g,v,b,x;t&&t.id;return e("main",async function(i,e){e&&i.output(h.green+"DEBUG mode enabled"),i.output(`${h.cyan}Use '${h.yellow}exit${h.cyan}' to quit`),i.output(`${h.cyan}Use '${h.yellow}state${h.cyan}' to print a state summary`);var c=n.createState({hostDictionary:r.hostDictionary,keepDebugInfo:e});let u=0;for(;;){var l=await i.getInput();try{let t=c.operands.length,r=c.usedMemory,n=0,s=!1;var p=c.parse(l,"repl"+u++);let{done:a,value:o}=p.next();for(;!1===a;){let e;o===g.$state?(d=c.dictionaries.length,i.output(h.cyan+"memory: "+h.yellow+m.memory(c)),i.output(h.cyan+"dictionaries: "+h.yellow+d),b.forEach(c.dictionaries,(e,t)=>{i.output(t+" "+x.formatters[e.type](e))}),i.output(h.cyan+"operands: "+h.yellow+c.operands.length),b.forEach(c.operands,(e,t)=>{let r;var{sourceFile:n,sourcePos:s}=e;r=void 0===n||void 0===s?"":` ${h.blue}@${n}(${s.toString()})`,i.output(t+" "+x.formatters[e.type](e)+r)})):o===g.$debug?s=!0:o===g.$load&&(f=c.operands.at(0)["data"],e=await i.getSample(f)),s&&(i.output(v.renderCallStack(c.calls).replace(/\u00bb.*\u00ab/g,e=>""+h.yellow+e+h.white).replace(/@.*\n/g,e=>""+h.blue+e+h.white).replace(/\/!\\.*\n/g,e=>""+h.red+e+h.white).replace(/\u2026|\u21b5|\u2b72/g,e=>""+h.blue+e+h.white)),i.output(m.status(c,{cycle:n,absolute:!0,lastOperandsCount:t,lastUsedMemory:r,concat:`${h.cyan}, ${h.yellow}c${h.cyan}ontinue, ${h.yellow}q${h.cyan}uit`})),t=c.operands.length,r=c.usedMemory,"q"===await i.getChar({c:"continue",q:"quit"}))&&(s=!1),++n;var d,f,y=p.next(e);a=y.done,o=y.value}i.output(m.status(c,{cycle:n,absolute:!1,lastOperandsCount:t,lastUsedMemory:r}))}catch(e){if(e instanceof s.ExitError)break;if(!(e instanceof a.BaseError)){i.output(""+h.red+e.toString());break}i.output(`${h.red}/!\\ ${e.name}: ${e.message}
`+e.callstack)}}}),{setters:[function(e){h=e},function(e){r=e},function(e){n=e},function(e){s=e},function(e){a=e},function(e){m=e},function(e){g=e},function(e){v=e},function(e){b=e},function(e){x=e}],execute:function(){}}});