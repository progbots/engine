System.register("index",[],(function(e,t){"use strict";var r;t&&t.id;return{setters:[],execute:function(){!function(e){e.boolean="booleantype",e.integer="integertype",e.string="stringtype",e.call="calltype",e.operator="operatortype",e.mark="marktype",e.array="arraytype",e.dict="dicttype",e.proc="proctype"}(r||(r={})),e("ValueType",r)}}})),System.register("state/parser",["index"],(function(e,t){"use strict";var r;t&&t.id;return e("parse",(function*parse(e,t){const n=/%[^\n]*|(?:"([^"]*)")|\s|((?:-|\+)?\d+)|(\[|\]|{|}|[^[\]{}}\s]+)/g;let o=n.exec(e);for(;null!==o;){const[,s,a,i]=o,c={type:r.ValueType.integer,data:0,source:e,sourcePos:o.index};void 0!==t&&(c.sourceFile=t),void 0!==s?yield{...c,type:r.ValueType.string,data:s}:void 0!==a?yield{...c,type:r.ValueType.integer,data:parseInt(a,10)}:void 0!==i&&(yield{...c,type:r.ValueType.call,data:i}),o=n.exec(e)}})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("errors/InternalError",["index"],(function(e,t){"use strict";var r,n,o,s,a,i,c;t&&t.id;return{setters:[function(e){r=e}],execute:function(){i=[n="type",o="name",s="message",a="stack"],"\n","",c=class InternalError extends Error{constructor(e){super(e),this._callstack="",this.name=this.constructor.name}get dictionary(){return this}release(){}get callstack(){return""!==this._callstack?this._callstack:this.stack?.split("\n").slice(1).join("\n")??""}set callstack(e){""===this._callstack&&(this._callstack=e)}get names(){return i}lookup(e){let t;return e===n?t="system":e===o?t=this.name:e===s?t=this.message:e===a&&(t=this.callstack),void 0!==t?{type:r.ValueType.string,data:t}:null}},e("InternalError",c)}}})),System.register("errors/Break",["errors/InternalError"],(function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){"Loop break",n=class Break extends r.InternalError{constructor(){super("Loop break")}},e("Break",n)}}})),System.register("errors/BusyParsing",["errors/InternalError"],(function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){"Engine is already busy parsing",n=class BusyParsing extends r.InternalError{constructor(){super("Engine is already busy parsing")}},e("BusyParsing",n)}}})),System.register("errors/DictStackUnderflow",["errors/InternalError"],(function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){"No custom dictionary left to unstack",n=class DictStackUnderflow extends r.InternalError{constructor(){super("No custom dictionary left to unstack")}},e("DictStackUnderflow",n)}}})),System.register("errors/Internal",["errors/InternalError"],(function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n=class Internal extends r.InternalError{set callstack(e){}},e("Internal",n)}}})),System.register("errors/InvalidAccess",["errors/InternalError"],(function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){"Object is read-only",n=class InvalidAccess extends r.InternalError{constructor(){super("Object is read-only")}},e("InvalidAccess",n)}}})),System.register("errors/InvalidBreak",["errors/InternalError"],(function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){"break has been invoked outside of a loop",n=class InvalidBreak extends r.InternalError{constructor(){super("break has been invoked outside of a loop")}},e("InvalidBreak",n)}}})),System.register("errors/RangeCheck",["errors/InternalError"],(function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){"Operand is too big or too small",n=class RangeCheck extends r.InternalError{constructor(){super("Operand is too big or too small")}},e("RangeCheck",n)}}})),System.register("errors/StackUnderflow",["errors/InternalError"],(function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){"Not enough operands on the stack to perform the operation",n=class StackUnderflow extends r.InternalError{constructor(){super("Not enough operands on the stack to perform the operation")}},e("StackUnderflow",n)}}})),System.register("errors/TypeCheck",["errors/InternalError"],(function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){"Operand is of the wrong type",n=class TypeCheck extends r.InternalError{constructor(){super("Operand is of the wrong type")}},e("TypeCheck",n)}}})),System.register("errors/Undefined",["errors/InternalError"],(function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){"Name is not defined in the dictionary stack",n=class Undefined extends r.InternalError{constructor(){super("Name is not defined in the dictionary stack")}},e("Undefined",n)}}})),System.register("errors/UnmatchedMark",["errors/InternalError"],(function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){"Unmatched mark in the operand stack",n=class UnmatchedMark extends r.InternalError{constructor(){super("Unmatched mark in the operand stack")}},e("UnmatchedMark",n)}}})),System.register("errors/VMerror",["errors/InternalError"],(function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){"Virtual memory error",n=class VMError extends r.InternalError{constructor(){super("Virtual memory error")}},e("VMError",n)}}})),System.register("errors/index",["errors/Break","errors/BusyParsing","errors/DictStackUnderflow","errors/Internal","errors/InvalidAccess","errors/InvalidBreak","errors/RangeCheck","errors/StackUnderflow","errors/TypeCheck","errors/Undefined","errors/UnmatchedMark","errors/VMerror"],(function(e,t){"use strict";t&&t.id;function exportStar_1(t){var r={};for(var n in t)"default"!==n&&(r[n]=t[n]);e(r)}return{setters:[function(e){exportStar_1(e)},function(e){exportStar_1(e)},function(e){exportStar_1(e)},function(e){exportStar_1(e)},function(e){exportStar_1(e)},function(e){exportStar_1(e)},function(e){exportStar_1(e)},function(e){exportStar_1(e)},function(e){exportStar_1(e)},function(e){exportStar_1(e)},function(e){exportStar_1(e)},function(e){exportStar_1(e)}],execute:function(){}}})),System.register("objects/ShareableObject",["errors/index"],(function(e,t){"use strict";var r;t&&t.id;return{setters:[function(e){r=e}],execute:function(){"Superfluous release",e("ShareableObject",class ShareableObject{static addRef(e){Array.isArray(e)?e.forEach((e=>{e.data instanceof ShareableObject&&e.data.addRef()})):e.data instanceof ShareableObject&&e.data.addRef()}static release(e){Array.isArray(e)?e.forEach((e=>{e.data instanceof ShareableObject&&e.data.release()})):e.data instanceof ShareableObject&&e.data.release()}constructor(){this._refCount=1}get refCount(){return this._refCount}addRef(){++this._refCount}release(){const e=--this._refCount;if(0===e)this._dispose();else if(e<0)throw new r.Internal("Superfluous release")}})}}})),System.register("state/MemoryTracker",["index","errors/index","objects/ShareableObject"],(function(e,t){"use strict";var r,n,o,s,a;t&&t.id;function isString(e){return[r.ValueType.string,r.ValueType.call].includes(e.type)}return{setters:[function(e){r=e},function(e){n=e},function(e){o=e}],execute:function(){s=e=>(new TextEncoder).encode(e).length+1,(a=class MemoryTracker{_addStringRef(e){const t=e.data,r=s(t);if(t.length>=MemoryTracker.CACHABLE_STRING_LENGTH){const e=this._strings.indexOf(t);return-1===e?(this._strings.push(t),this._stringsRefCount.push(1),r+MemoryTracker.INTEGER_SIZE):(++this._stringsRefCount[e],0)}return r}_releaseString(e){const t=e.data,r=s(t);if(t.length>=MemoryTracker.CACHABLE_STRING_LENGTH){const e=this._strings.indexOf(t);return 0===--this._stringsRefCount[e]?r+MemoryTracker.INTEGER_SIZE:0}return r}constructor(e=1/0){this._total=e,this._used=0,this._strings=[],this._stringsRefCount=[]}get used(){return this._used}get total(){return this._total}addValueRef(e){let t=MemoryTracker.VALUE_SIZE;!0!==e.untracked&&(isString(e)?t+=this._addStringRef(e):o.ShareableObject.addRef(e)),this.increment(t)}releaseValue(e){let t=MemoryTracker.VALUE_SIZE;!0!==e.untracked&&(isString(e)?t+=this._releaseString(e):o.ShareableObject.release(e)),this.decrement(t)}increment(e){if(this._used+=e,this._used>this._total)throw new n.VMError}decrement(e){this._used-=e}}).POINTER_SIZE=4,a.INTEGER_SIZE=4,a.VALUE_TYPE_SIZE=1,a.VALUE_SIZE=a.VALUE_TYPE_SIZE+a.POINTER_SIZE,a.CACHABLE_STRING_LENGTH=32,e("MemoryTracker",a)}}})),System.register("objects/BaseArray",["objects/ShareableObject","state/MemoryTracker","errors/index","errors/InternalError"],(function(e,t){"use strict";var r,n,o,s,a;t&&t.id;return{setters:[function(e){r=e},function(e){n=e},function(e){o=e},function(e){s=e}],execute:function(){"Empty array",(a=class BaseArray extends r.ShareableObject{constructor(e){super(),this._memoryTracker=e,this._values=[],this._memoryTracker.increment(BaseArray.INITIAL_SIZE)}get length(){return this._values.length}at(e){const t=this._values[e];if(void 0===t)throw new o.RangeCheck;return Object.assign({},t)}addValueRef(e){this._memoryTracker.addValueRef(e),this._memoryTracker.increment(BaseArray.VALUE_ADDITIONAL_SIZE)}push(e){this.addValueRef(e),this.pushImpl(e)}releaseValue(e){this._memoryTracker.releaseValue(e),this._memoryTracker.decrement(BaseArray.VALUE_ADDITIONAL_SIZE)}pop(){if(0===this._values.length)throw new s.InternalError("Empty array");const e=this.popImpl();this.releaseValue(e)}get ref(){return this._values}_clear(){for(const e of this._values)this._memoryTracker.releaseValue(e);this._memoryTracker.decrement(this._values.length*BaseArray.VALUE_ADDITIONAL_SIZE),this._values.length=0}_dispose(){this._clear(),this._memoryTracker.decrement(BaseArray.INITIAL_SIZE)}}).INITIAL_SIZE=n.MemoryTracker.POINTER_SIZE,a.VALUE_ADDITIONAL_SIZE=n.MemoryTracker.POINTER_SIZE,e("BaseArray",a)}}})),System.register("objects/stacks/Stack",["errors/index","objects/BaseArray"],(function(e,t){"use strict";var r,n,o;t&&t.id;return{setters:[function(e){r=e},function(e){n=e}],execute:function(){o=class Stack extends n.BaseArray{pushImpl(e){this._values.unshift(e)}popImpl(){return this._values.shift()}pop(){if(0===this._values.length)throw new r.StackUnderflow;super.pop()}},e("Stack",o)}}})),System.register("objects/stacks/Operand",["index","errors/index","objects/stacks/Stack"],(function(e,t){"use strict";var r,n,o,s;t&&t.id;return{setters:[function(e){r=e},function(e){n=e},function(e){o=e}],execute:function(){s=class OperandStack extends o.Stack{check(...e){if(e.length>this._values.length)throw new n.StackUnderflow;return e.map(((e,t)=>{const r=this._values[t];if(null!==e&&r.type!==e)throw new n.TypeCheck;return r}))}splice(e,t){if(this.length<e)throw new n.StackUnderflow;const r=this._values.splice(0,e);if(void 0!==t){Array.isArray(t)||(t=[t]);for(const e of t)this.push(e)}for(const e of r)this.releaseValue(e)}findMarkPos(){const e=this._values.findIndex((e=>e.type===r.ValueType.mark));if(-1===e)throw new n.UnmatchedMark;return e}},e("OperandStack",s)}}})),System.register("objects/dictionaries/types",["errors/index"],(function(e,t){"use strict";var r;t&&t.id;return e("checkIWritableDictionary",(function checkIWritableDictionary(e){const t=e.def;if("function"!=typeof t||2!==t.length)throw new r.InvalidAccess})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("objects/dictionaries/Dictionary",["index","state/MemoryTracker","objects/ShareableObject"],(function(e,t){"use strict";var r,n,o,s;t&&t.id;return{setters:[function(e){r=e},function(e){n=e},function(e){o=e}],execute:function(){(s=class Dictionary extends o.ShareableObject{constructor(e){super(),this._memoryTracker=e,this._values={},this._memoryTracker.increment(Dictionary.INITIAL_SIZE)}get names(){return Object.keys(this._values)}lookup(e){const t=this._values[e];return void 0===t?null:t}def(e,t){const n=this._values[e];void 0!==n?this._memoryTracker.releaseValue(n):(this._memoryTracker.addValueRef({type:r.ValueType.string,data:e}),this._memoryTracker.increment(Dictionary.VALUE_ADDITIONAL_SIZE)),this._memoryTracker.addValueRef(t),this._values[e]=t}_dispose(){this.names.forEach((e=>{const t=this._values[e];this._memoryTracker.releaseValue(t),this._memoryTracker.releaseValue({type:r.ValueType.string,data:e}),this._memoryTracker.decrement(Dictionary.VALUE_ADDITIONAL_SIZE)})),this._memoryTracker.decrement(Dictionary.INITIAL_SIZE)}}).INITIAL_SIZE=n.MemoryTracker.POINTER_SIZE,s.VALUE_ADDITIONAL_SIZE=3*n.MemoryTracker.POINTER_SIZE,e("Dictionary",s)}}})),System.register("objects/dictionaries/Host",["objects/ShareableObject"],(function(e,t){"use strict";var r,n;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n=class HostDictionary extends r.ShareableObject{get names(){return this._hostDictionary.names}lookup(e){return this._hostDictionary.lookup(e)}constructor(e){super(),this._hostDictionary=e}_dispose(){}},e("HostDictionary",n)}}})),System.register("operators/integer",["index"],(function(e,t){"use strict";var r;t&&t.id;function extract({operands:e}){return e.check(r.ValueType.integer,r.ValueType.integer).map((e=>e.data))}return e("compare",(function compare(e,t){const[n,o]=extract(e);e.operands.splice(2,{type:r.ValueType.boolean,data:t(o,n)})})),e("compute",(function compute(e,t){const[n,o]=extract(e);e.operands.splice(2,{type:r.ValueType.integer,data:t(o,n)})})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("operators/add",["operators/integer"],(function(e,t){"use strict";var r;t&&t.id;return e("add",(function*add(e){r.compute(e,((e,t)=>e+t))})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("objects/Array",["errors/index","objects/BaseArray"],(function(e,t){"use strict";var r,n,o;t&&t.id;return{setters:[function(e){r=e},function(e){n=e}],execute:function(){"Empty array",o=class ArrayLike extends n.BaseArray{pushImpl(e){this._values.push(e)}popImpl(){const e=this._values.at(-1);return this._values.pop(),e}shift(){const e=this._values.shift();if(void 0===e)throw new r.Internal("Empty array");return this.releaseValue(e),e}unshift(e){this.addValueRef(e),this._values.unshift(e)}set(e,t){if(e<0)throw new r.RangeCheck;const n=this._values[e];this.addValueRef(t),void 0!==n&&this.releaseValue(n),this._values[e]=t}some(e){return this._values.some(e)}},e("ArrayLike",o)}}})),System.register("operators/aload",["index","errors/index"],(function(e,t){"use strict";var r,n;t&&t.id;return e("aload",(function*aload({operands:e}){const[{type:t,data:o}]=e.check(null);if(![r.ValueType.array,r.ValueType.proc].includes(t))throw new n.TypeCheck;const s=o,{length:a}=s;s.addRef();try{e.pop();for(let t=0;t<a;++t){const r=s.at(t);e.push(r)}}finally{s.release()}})),{setters:[function(e){r=e},function(e){n=e}],execute:function(){}}})),System.register("operators/apush",["index"],(function(e,t){"use strict";var r;t&&t.id;return e("apush",(function*apush({operands:e}){const[t,{data:n}]=e.check(null,r.ValueType.array);n.push(t),e.splice(2)})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("operators/begin",["index"],(function(e,t){"use strict";var r;t&&t.id;return e("begin",(function*begin({operands:e,dictionaries:t}){const[n]=e.check(r.ValueType.dict);t.begin(n.data),e.pop()})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("operators/bind",["index","errors/index"],(function(e,t){"use strict";var r,n;t&&t.id;return e("bind",(function*bind({operands:e,dictionaries:t}){const[o]=e.check(r.ValueType.proc),s=[o.data];for(const e of s)for(let o=0;o<e.ref.length;++o){const a=e.at(o);if(a.type===r.ValueType.call){yield;try{const r=t.lookup(a.data);e.set(o,{...a,...r})}catch(e){if(!(e instanceof n.Undefined))throw e}}else a.type===r.ValueType.proc&&s.push(a.data)}})),{setters:[function(e){r=e},function(e){n=e}],execute:function(){}}})),System.register("operators/catch",["index","objects/ShareableObject","errors/InternalError"],(function(e,t){"use strict";var r,n,o;t&&t.id;function*catchOp(e){const{operands:t}=e,[s,a]=t.check(r.ValueType.proc,r.ValueType.proc);n.ShareableObject.addRef([a,s]);try{t.splice(2),yield*e.eval(a)}catch(n){if(!(n instanceof o.InternalError))throw n;t.push({type:r.ValueType.dict,data:n.dictionary}),n.release(),yield*e.eval(s)}finally{n.ShareableObject.release([a,s])}}return e("catchOp",catchOp),{setters:[function(e){r=e},function(e){n=e},function(e){o=e}],execute:function(){Object.defineProperty(catchOp,"name",{value:"catch",writable:!1})}}})),System.register("operators/clear",[],(function(e,t){"use strict";t&&t.id;return e("clear",(function*clear({operands:e}){e.splice(e.length)})),{setters:[],execute:function(){}}})),System.register("operators/cleartomark",[],(function(e,t){"use strict";t&&t.id;return e("cleartomark",(function*cleartomark({operands:e}){e.splice(e.findMarkPos()+1)})),{setters:[],execute:function(){}}})),System.register("operators/open-close-helper",["index","objects/Array"],(function(e,t){"use strict";var r,n;t&&t.id;return e("openWithMark",(function openWithMark({operands:e,calls:t}){const n=t.ref[1];e.push({...n,type:r.ValueType.mark,data:null})})),e("closeToMark",(function closeToMark(e,t){const{operands:r}=e,o=r.findMarkPos(),s=r.ref[o],a=new n.ArrayLike(e.memoryTracker);try{let e;for(e=0;e<o;++e)a.unshift(r.ref[e]);r.splice(o+1,{...s,type:t,data:a})}finally{a.release()}})),{setters:[function(e){r=e},function(e){n=e}],execute:function(){}}})),System.register("operators/close-array",["index","operators/open-close-helper"],(function(e,t){"use strict";var r,n;t&&t.id;function*closeArray(e){n.closeToMark(e,r.ValueType.array)}return e("closeArray",closeArray),{setters:[function(e){r=e},function(e){n=e}],execute:function(){Object.defineProperty(closeArray,"name",{value:"]",writable:!1})}}})),System.register("operators/close-proc",["index","operators/open-close-helper"],(function(e,t){"use strict";var r,n;t&&t.id;function*closeProc(e){n.closeToMark(e,r.ValueType.proc),e.allowCall()}return e("closeProc",closeProc),{setters:[function(e){r=e},function(e){n=e}],execute:function(){Object.defineProperty(closeProc,"name",{value:"}",writable:!1})}}})),System.register("operators/count",["index"],(function(e,t){"use strict";var r;t&&t.id;return e("count",(function*count({operands:e}){e.push({type:r.ValueType.integer,data:e.length})})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("operators/counttomark",["index"],(function(e,t){"use strict";var r;t&&t.id;return e("counttomark",(function*counttomark({operands:e}){e.push({type:r.ValueType.integer,data:e.findMarkPos()})})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("operators/currentdict",[],(function(e,t){"use strict";t&&t.id;return e("currentdict",(function*currentdict({operands:e,dictionaries:t}){e.push(t.at(0))})),{setters:[],execute:function(){}}})),System.register("operators/def",["index","objects/dictionaries/index"],(function(e,t){"use strict";var r,n;t&&t.id;return e("def",(function*def({operands:e,dictionaries:t}){const[o,s]=e.check(null,r.ValueType.string),{data:a}=t.at(0),i=a;n.checkIWritableDictionary(i),i.def(s.data,o),e.splice(2)})),{setters:[function(e){r=e},function(e){n=e}],execute:function(){}}})),System.register("operators/dict",["index","objects/dictionaries/index"],(function(e,t){"use strict";var r,n;t&&t.id;return e("dict",(function*dict(e){const t=new n.Dictionary(e.memoryTracker);e.operands.push({type:r.ValueType.dict,data:t}),t.release()})),{setters:[function(e){r=e},function(e){n=e}],execute:function(){}}})),System.register("operators/dictstack",["objects/Array","index"],(function(e,t){"use strict";var r,n;t&&t.id;return e("dictstack",(function*dictstack(e){const t=new r.ArrayLike(e.memoryTracker),{operands:o,dictionaries:s}=e;try{for(const e of s.ref)t.push(e);o.push({type:n.ValueType.array,data:t})}finally{t.release()}})),{setters:[function(e){r=e},function(e){n=e}],execute:function(){}}})),System.register("operators/dup",[],(function(e,t){"use strict";t&&t.id;return e("dup",(function*dup({operands:e}){const[t]=e.check(null);e.push(t)})),{setters:[],execute:function(){}}})),System.register("operators/end",[],(function(e,t){"use strict";t&&t.id;return e("end",(function*end({dictionaries:e}){e.end()})),{setters:[],execute:function(){}}})),System.register("operators/eq",["index"],(function(e,t){"use strict";var r;t&&t.id;return e("eq",(function*eq({operands:e}){const[t,n]=e.check(null,null);e.splice(2,{type:r.ValueType.boolean,data:t.type===n.type&&t.data===n.data})})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("operators/exch",[],(function(e,t){"use strict";t&&t.id;return e("exch",(function*exch({operands:e}){const t=e.check(null,null);e.splice(2,t)})),{setters:[],execute:function(){}}})),System.register("operators/false",["index"],(function(e,t){"use strict";var r;t&&t.id;function*falseOp({operands:e}){e.push({type:r.ValueType.boolean,data:!1})}return e("falseOp",falseOp),{setters:[function(e){r=e}],execute:function(){Object.defineProperty(falseOp,"name",{value:"false",writable:!1})}}})),System.register("operators/finally",["index","objects/ShareableObject"],(function(e,t){"use strict";var r,n;t&&t.id;function*finallyOp(e){const{operands:t}=e,[o,s]=t.check(r.ValueType.proc,r.ValueType.proc);n.ShareableObject.addRef([s,o]);let a=!1;const release=()=>{a||(n.ShareableObject.release([s,o]),a=!0)};try{t.splice(2),yield*e.eval(s)}finally{try{yield*e.eval(o)}finally{release()}release()}}return e("finallyOp",finallyOp),{setters:[function(e){r=e},function(e){n=e}],execute:function(){Object.defineProperty(finallyOp,"name",{value:"finally",writable:!1})}}})),System.register("operators/get",["index","errors/index"],(function(e,t){"use strict";var r,n,o;t&&t.id;function arrayLikeGetter(e,t){if(t.type!==r.ValueType.integer)throw new n.TypeCheck;const o=t.data;return e.data.at(o)}return e("get",(function*get({operands:e}){const[t,r]=e.check(null,null),s=o[r.type];if(void 0===s)throw new n.TypeCheck;const a=s(r,t);e.splice(2,a)})),{setters:[function(e){r=e},function(e){n=e}],execute:function(){o={[r.ValueType.string]:(e,t)=>{if(t.type!==r.ValueType.integer)throw new n.TypeCheck;const o=t.data,s=e.data;if(o<0||o>=s.length)throw new n.RangeCheck;return{type:r.ValueType.integer,data:s.charCodeAt(o)}},[r.ValueType.array]:arrayLikeGetter,[r.ValueType.dict]:(e,t)=>{if(t.type!==r.ValueType.string)throw new n.TypeCheck;const o=t.data,s=e.data.lookup(o);if(null===s)throw new n.Undefined;return s},[r.ValueType.proc]:arrayLikeGetter}}}})),System.register("operators/globaldict",["index"],(function(e,t){"use strict";var r;t&&t.id;return e("globaldict",(function*globaldict({operands:e,dictionaries:t}){e.push({type:r.ValueType.dict,data:t.globaldict})})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("operators/gt",["operators/integer"],(function(e,t){"use strict";var r;t&&t.id;return e("gt",(function*gt(e){r.compare(e,((e,t)=>e>t))})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("operators/gte",["operators/integer"],(function(e,t){"use strict";var r;t&&t.id;return e("gte",(function*gte(e){r.compare(e,((e,t)=>e>=t))})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("operators/if",["index","objects/ShareableObject"],(function(e,t){"use strict";var r,n;t&&t.id;function*ifOp(e){const{operands:t}=e,[o,s]=t.check(r.ValueType.proc,r.ValueType.boolean);n.ShareableObject.addRef(o);try{t.splice(2),s.data&&(yield*e.eval(o))}finally{n.ShareableObject.release(o)}}return e("ifOp",ifOp),{setters:[function(e){r=e},function(e){n=e}],execute:function(){Object.defineProperty(ifOp,"name",{value:"if",writable:!1})}}})),System.register("operators/ifelse",["index","objects/ShareableObject"],(function(e,t){"use strict";var r,n;t&&t.id;return e("ifelse",(function*ifelse(e){const{operands:t}=e,[o,s,a]=t.check(r.ValueType.proc,r.ValueType.proc,r.ValueType.boolean);n.ShareableObject.addRef([s,o]);try{t.splice(3),a.data?yield*e.eval(s):yield*e.eval(o)}finally{n.ShareableObject.release([s,o])}})),{setters:[function(e){r=e},function(e){n=e}],execute:function(){}}})),System.register("operators/in",["index","errors/index"],(function(e,t){"use strict";var r,n,o;t&&t.id;function arrayLikeImpl(e,t){return e.data.some((e=>e.type===t.type&&e.data===t.data))}function*inOp({operands:e}){const[t,s]=e.check(null,null),a=o[s.type];if(void 0===a)throw new n.TypeCheck;e.splice(2,{type:r.ValueType.boolean,data:a(s,t)})}return e("inOp",inOp),{setters:[function(e){r=e},function(e){n=e}],execute:function(){o={[r.ValueType.array]:arrayLikeImpl,[r.ValueType.dict]:(e,t)=>{if(t.type!==r.ValueType.string)throw new n.TypeCheck;const o=t.data;return e.data.names.includes(o)},[r.ValueType.proc]:arrayLikeImpl},Object.defineProperty(inOp,"name",{value:"in",writable:!1})}}})),System.register("operators/index-op",["index","errors/index"],(function(e,t){"use strict";var r,n;t&&t.id;return e("index",(function*index({operands:e}){const[t]=e.check(r.ValueType.integer).map((e=>e.data));if(t<0)throw new n.RangeCheck;const o=t+1;if(o>=e.length)throw new n.StackUnderflow;e.splice(1,e.ref[o])})),{setters:[function(e){r=e},function(e){n=e}],execute:function(){}}})),System.register("operators/length",["index","errors/index"],(function(e,t){"use strict";var r,n,o;t&&t.id;function arrayLikeLength(e){return e.data.length}return e("length",(function*length({operands:e}){const[t]=e.check(null),s=o[t.type];if(void 0===s)throw new n.TypeCheck;e.splice(1,{type:r.ValueType.integer,data:s(t)})})),{setters:[function(e){r=e},function(e){n=e}],execute:function(){o={[r.ValueType.string]:e=>e.data.length,[r.ValueType.array]:arrayLikeLength,[r.ValueType.dict]:e=>e.data.names.length,[r.ValueType.proc]:arrayLikeLength}}}})),System.register("operators/loop",["index","errors/index","objects/ShareableObject"],(function(e,t){"use strict";var r,n,o;t&&t.id;return e("loop",(function*loop(e){const{operands:t}=e,[s]=t.check(r.ValueType.proc);o.ShareableObject.addRef(s);try{for(t.pop();;)yield*e.eval(s)}catch(e){if(!(e instanceof n.Break))throw e}finally{o.ShareableObject.release(s)}})),{setters:[function(e){r=e},function(e){n=e},function(e){o=e}],execute:function(){}}})),System.register("operators/lt",["operators/integer"],(function(e,t){"use strict";var r;t&&t.id;return e("lt",(function*lt(e){r.compare(e,((e,t)=>e<t))})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("operators/lte",["operators/integer"],(function(e,t){"use strict";var r;t&&t.id;return e("lte",(function*lte(e){r.compare(e,((e,t)=>e<=t))})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("operators/mark",["index"],(function(e,t){"use strict";var r;t&&t.id;return e("mark",(function*mark({operands:e}){e.push({type:r.ValueType.mark,data:null})})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("operators/neq",["index"],(function(e,t){"use strict";var r;t&&t.id;return e("neq",(function*neq({operands:e}){const[t,n]=e.check(null,null);e.splice(2,{type:r.ValueType.boolean,data:t.type!==n.type||t.data!==n.data})})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("operators/open-array",["operators/open-close-helper"],(function(e,t){"use strict";var r;t&&t.id;function*openArray(e){r.openWithMark(e)}return e("openArray",openArray),{setters:[function(e){r=e}],execute:function(){Object.defineProperty(openArray,"name",{value:"[",writable:!1})}}})),System.register("operators/open-proc",["operators/open-close-helper"],(function(e,t){"use strict";var r;t&&t.id;function*openProc(e){r.openWithMark(e),e.preventCall()}return e("openProc",openProc),{setters:[function(e){r=e}],execute:function(){Object.defineProperty(openProc,"name",{value:"{",writable:!1})}}})),System.register("operators/pop",[],(function(e,t){"use strict";t&&t.id;return e("pop",(function*pop({operands:e}){e.pop()})),{setters:[],execute:function(){}}})),System.register("operators/roll",["errors/index","index"],(function(e,t){"use strict";var r,n;t&&t.id;return e("roll",(function*roll({operands:e}){const[t,o]=e.check(n.ValueType.integer,n.ValueType.integer).map((e=>e.data));if(o<=0)throw new r.RangeCheck;const s=e.ref.slice(2,2+o).reverse(),a=[...s,...s],i=(o-t)%o;e.splice(2+o,a.slice(i,i+o))})),{setters:[function(e){r=e},function(e){n=e}],execute:function(){}}})),System.register("operators/set",["index","errors/index","objects/dictionaries/index"],(function(e,t){"use strict";var r,n,o,s;t&&t.id;return e("set",(function*set({operands:e}){const[t,r,o]=e.check(null,null,null),a=s[o.type];if(void 0===a)throw new n.TypeCheck;e.splice(3,a(o,r,t))})),{setters:[function(e){r=e},function(e){n=e},function(e){o=e}],execute:function(){s={[r.ValueType.string]:(e,t,o)=>{if(t.type!==r.ValueType.integer||o.type!==r.ValueType.integer)throw new n.TypeCheck;const s=t.data,a=e.data;if(s<0||s>=a.length)throw new n.RangeCheck;return{type:r.ValueType.string,data:[a.substring(0,s),String.fromCharCode(o.data),a.substring(s+1)].join("")}},[r.ValueType.array]:(e,t,o)=>{if(t.type!==r.ValueType.integer)throw new n.TypeCheck;const s=t.data,a=e.data;if(s>=a.length)throw new n.RangeCheck;return a.set(s,o),e},[r.ValueType.dict]:(e,t,s)=>{if(t.type!==r.ValueType.string)throw new n.TypeCheck;const a=t.data,i=e.data;return o.checkIWritableDictionary(i),i.def(a,s),e}}}}})),System.register("operators/sub",["operators/integer"],(function(e,t){"use strict";var r;t&&t.id;return e("sub",(function*sub(e){r.compute(e,((e,t)=>e-t))})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("operators/systemdict",["index"],(function(e,t){"use strict";var r;t&&t.id;return e("systemdict",(function*systemdict({operands:e,dictionaries:t}){e.push({type:r.ValueType.dict,data:t.systemdict})})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("errors/Custom",["index","objects/ShareableObject","errors/InternalError","errors/TypeCheck"],(function(e,t){"use strict";var r,n,o,s,a,i;t&&t.id;return{setters:[function(e){r=e},function(e){n=e},function(e){o=e},function(e){s=e}],execute:function(){"name","message",a=(e,t)=>{const n=e.lookup(t);if(null===n||n.type!==r.ValueType.string)throw new s.TypeCheck;return n.data},i=class Custom extends o.InternalError{constructor(e){super(a(e,"message")),this._dictionary=e,this.name=this.name+`:${a(e,"name")}`}get dictionary(){return this._dictionary}release(){n.ShareableObject.release({type:r.ValueType.dict,data:this._dictionary})}get names(){return this._dictionary.names}lookup(e){return this._dictionary.lookup(e)}def(e,t){this._dictionary.def(e,t)}},e("Custom",i)}}})),System.register("operators/throw",["index","objects/ShareableObject","errors/index","objects/dictionaries/index","errors/Custom","errors/InternalError"],(function(e,t){"use strict";var r,n,o,s,a,i;t&&t.id;function*throwOp({operands:e}){const[t]=e.check(r.ValueType.dict),c=t.data;if(c instanceof i.InternalError)throw c;try{s.checkIWritableDictionary(c)}catch(e){throw new o.TypeCheck}const u=new a.Custom(c);throw n.ShareableObject.addRef(t),e.pop(),u}return e("throwOp",throwOp),{setters:[function(e){r=e},function(e){n=e},function(e){o=e},function(e){s=e},function(e){a=e},function(e){i=e}],execute:function(){Object.defineProperty(throwOp,"name",{value:"throw",writable:!1})}}})),System.register("operators/true",["index"],(function(e,t){"use strict";var r;t&&t.id;function*trueOp({operands:e}){e.push({type:r.ValueType.boolean,data:!0})}return e("trueOp",trueOp),{setters:[function(e){r=e}],execute:function(){Object.defineProperty(trueOp,"name",{value:"true",writable:!1})}}})),System.register("operators/type",["index"],(function(e,t){"use strict";var r;t&&t.id;return e("type",(function*type({operands:e}){const[{type:t}]=e.check(null);e.splice(1,{type:r.ValueType.string,data:t})})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("operators/index",["operators/add","operators/aload","operators/apush","operators/begin","operators/bind","operators/catch","operators/clear","operators/cleartomark","operators/close-array","operators/close-proc","operators/count","operators/counttomark","operators/currentdict","operators/def","operators/dict","operators/dictstack","operators/dup","operators/end","operators/eq","operators/exch","operators/false","operators/finally","operators/get","operators/globaldict","operators/gt","operators/gte","operators/if","operators/ifelse","operators/in","operators/index-op","operators/length","operators/loop","operators/lt","operators/lte","operators/mark","operators/neq","operators/open-array","operators/open-proc","operators/pop","operators/roll","operators/set","operators/sub","operators/systemdict","operators/throw","operators/true","operators/type"],(function(e,t){"use strict";t&&t.id;function exportStar_2(t){var r={};for(var n in t)"default"!==n&&(r[n]=t[n]);e(r)}return{setters:[function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)},function(e){exportStar_2(e)}],execute:function(){}}})),System.register("operators/errors",["errors/index"],(function(e,t){"use strict";var r,n,o;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n={},o=["BusyParsing","DictStackUnderflow","Internal","InvalidBreak"],Object.values(r).forEach((e=>{if(o.includes(e.name))return;const t=e,operator=function*(e){throw new t};Object.defineProperty(operator,"name",{value:e.name.toLowerCase(),writable:!1}),n[operator.name]=operator})),e("default",n)}}})),System.register("objects/dictionaries/System",["index","objects/ShareableObject","operators/index","operators/errors"],(function(e,t){"use strict";var r,n,o,s,a,i;t&&t.id;return{setters:[function(e){r=e},function(e){n=e},function(e){o=e},function(e){s=e}],execute:function(){a={},Object.values(o).forEach((e=>{a[e.name]=e})),Object.values(s.default).forEach((e=>{a[e.name]=e})),i=class SystemDictionary extends n.ShareableObject{get names(){return Object.keys(a)}lookup(e){const t=a[e];return void 0===t?null:{type:r.ValueType.operator,data:t}}_dispose(){}},e("SystemDictionary",i)}}})),System.register("objects/dictionaries/index",["objects/dictionaries/Dictionary","objects/dictionaries/Host","objects/dictionaries/System","objects/dictionaries/types"],(function(e,t){"use strict";t&&t.id;function exportStar_3(t){var r={};for(var n in t)"default"!==n&&(r[n]=t[n]);e(r)}return{setters:[function(e){exportStar_3(e)},function(e){exportStar_3(e)},function(e){exportStar_3(e)},function(e){exportStar_3(e)}],execute:function(){}}})),System.register("objects/stacks/Dictionary",["index","errors/index","objects/stacks/Stack","objects/dictionaries/index"],(function(e,t){"use strict";var r,n,o,s,a;t&&t.id;return{setters:[function(e){r=e},function(e){n=e},function(e){o=e},function(e){s=e}],execute:function(){a=class DictionaryStack extends o.Stack{constructor(e,t){super(e),this._systemdict=new s.SystemDictionary,void 0!==t&&this.begin(new s.HostDictionary(t)),this.begin(this._systemdict),this._globaldict=new s.Dictionary(e),this.begin(this._globaldict),this._minDictCount=this._values.length}get systemdict(){return this._systemdict}get globaldict(){return this._globaldict}begin(e){this.push({type:r.ValueType.dict,data:e})}end(){if(this.length===this._minDictCount)throw new n.DictStackUnderflow;this.pop()}lookup(e){for(const t of this._values){const r=t.data.lookup(e);if(null!==r)return r}throw new n.Undefined}},e("DictionaryStack",a)}}})),System.register("objects/stacks/index",["objects/stacks/Stack","objects/stacks/Operand","objects/stacks/Dictionary"],(function(e,t){"use strict";t&&t.id;function exportStar_4(t){var r={};for(var n in t)"default"!==n&&(r[n]=t[n]);e(r)}return{setters:[function(e){exportStar_4(e)},function(e){exportStar_4(e)},function(e){exportStar_4(e)}],execute:function(){}}})),System.register("formatters",["index","objects/dictionaries/index"],(function(e,t){"use strict";var r,n,o;t&&t.id;return{setters:[function(e){r=e},function(e){n=e}],execute:function(){e("formatters",o={[r.ValueType.boolean]:e=>e.data?"true":"false",[r.ValueType.integer]:e=>e.data.toString(),[r.ValueType.string]:e=>JSON.stringify(e.data),[r.ValueType.call]:e=>e.data,[r.ValueType.operator]:e=>`-${e.data.name}-`,[r.ValueType.mark]:e=>"--mark--",[r.ValueType.array]:e=>{const t=["["],r=e.data,{length:n}=r;for(let e=0;e<n;++e){const n=r.at(e);t.push(o[n.type](n))}return t.push("]"),t.join(" ")},[r.ValueType.dict]:e=>{const t=e.data;return e.data instanceof n.HostDictionary?`--hostdict(${t.names.length.toString()})--`:e.data instanceof n.SystemDictionary?`--systemdict(${t.names.length.toString()})--`:`--dictionary(${t.names.length.toString()})--`},[r.ValueType.proc]:e=>{const t=["{"],r=e.data,{length:n}=r;for(let e=0;e<n;++e){const n=r.at(e);t.push(o[n.type](n))}return t.push("}"),t.join(" ")}})}}})),System.register("state/callstack",["index","formatters","state/parser","errors/index"],(function(e,t){"use strict";var r,n,o,s,a,i;t&&t.id;function stringify(e){return JSON.stringify(e.replace(/\r?\n/g,"\u21b5").replace(/\t/g,"\u2b72"))}return e("renderCallStack",(function renderCallStack(e){const{length:t}=e,n=[];let o;for(let s=0;s<t;++s){const t=e.at(s);if(t.type===r.ValueType.integer){o=t.data;continue}let a="";const{sourceFile:c,sourcePos:u}=t;void 0!==c&&void 0!==u&&(a=` @${c}:${u.toString()}`);const l=i[t.type](t,o);n.push(l+a),o=void 0}return n.join("\n")})),{setters:[function(e){r=e},function(e){n=e},function(e){o=e},function(e){s=e}],execute:function(){"\u00bb","\u00ab","Unexpected parser failure",a=e=>`/!\\ unexpected stack item type ${e.type}`,i={[r.ValueType.boolean]:a,[r.ValueType.integer]:a,[r.ValueType.string]:(e,t)=>{const r=e.data;if(void 0!==t){const e=r.substring(0,t),a=o.parse(r.substring(t)),{value:i}=a.next();if(void 0===i)throw new s.Internal("Unexpected parser failure");const c=n.formatters[i.type](i);return stringify(`${e}\u00bb${c}\u00ab${r.substring(t+c.length)}`)}return stringify(r)},[r.ValueType.call]:e=>n.formatters[e.type](e),[r.ValueType.operator]:(e,t)=>{const r=n.formatters[e.type](e);return void 0!==t?`${r}:${t}`:r},[r.ValueType.mark]:a,[r.ValueType.array]:a,[r.ValueType.dict]:a,[r.ValueType.proc]:(e,t)=>{const r=["{"],o=e.data,{length:s}=o;for(let e=0;e<s;++e){const s=o.at(e);t===e?r.push("\u00bb"+n.formatters[s.type](s)+"\u00ab"):r.push(n.formatters[s.type](s))}return r.push("}"),r.join(" ")}}}}})),System.register("state/State",["index","errors/index","state/index","objects/stacks/index","state/MemoryTracker","errors/InternalError","state/callstack"],(function(e,t){"use strict";var r,n,o,s,a,i,c;t&&t.id;return{setters:[function(e){r=e},function(e){n=e},function(e){o=e},function(e){s=e},function(e){a=e},function(e){i=e},function(e){c=e}],execute:function(){e("State",class State{constructor(e={}){this._keepDebugInfo=!1,this._noCall=0,this._parsing=!1,this._memoryTracker=new a.MemoryTracker(e.maxMemoryBytes),this._dictionaries=new s.DictionaryStack(this._memoryTracker,e.hostDictionary),this._operands=new s.OperandStack(this._memoryTracker),this._calls=new s.Stack(this._memoryTracker),!0===e.keepDebugInfo&&(this._keepDebugInfo=!0)}get usedMemory(){return this._memoryTracker.used}get totalMemory(){return this._memoryTracker.total}get operands(){return this._operands}get dictionaries(){return this._dictionaries}get calls(){return this._calls}get parsing(){return this._parsing}parse(e,t){return this._parsing&&this.wrapError(new n.BusyParsing),this._parsing=!0,this.outerParse(e,t)}get memoryTracker(){return this._memoryTracker}get keepDebugInfo(){return this._keepDebugInfo}preventCall(){++this._noCall}allowCall(){--this._noCall}wrapError(e){if(e instanceof n.Break){const t=new n.InvalidBreak;t.callstack=e.callstack,e=t}if(e instanceof i.InternalError){const t=new Error(e.message);throw t.name=e.name,t.stack=e.callstack,e.release(),t}throw e}*wrapCall(e,t){this._calls.push(e),yield;try{yield*t.apply(this)}catch(e){throw e instanceof i.InternalError&&(e.callstack=c.renderCallStack(this.calls)),e}finally{this._calls.pop()}}*evalCall(e){yield*this.wrapCall(e,(function*(){yield*this.eval(this._dictionaries.lookup(e.data))}))}*evalOperator(e){yield*this.wrapCall(e,(function*(){const t=e.data;yield*t(this)}))}*evalProc(e){yield*this.wrapCall(e,(function*(){const t=e.data,{length:n}=t;for(let e=0;e<n;++e){this._calls.push({type:r.ValueType.integer,data:e});try{yield*this.evalWithoutProc(t.at(e))}finally{this._calls.pop()}}}))}*evalWithoutProc(e){e.type!==r.ValueType.call||0!==this._noCall&&!["{","}"].includes(e.data)?e.type===r.ValueType.operator?yield*this.evalOperator(e):(yield,this.operands.push(e)):yield*this.evalCall(e)}*eval(e){e.type===r.ValueType.proc?yield*this.evalProc(e):yield*this.evalWithoutProc(e)}*outerParse(e,t){try{yield*this.innerParse(e,t)}catch(e){this.wrapError(e)}finally{this._parsing=!1}}*innerParse(e,t){yield*this.wrapCall({type:r.ValueType.string,data:e,untracked:!0,sourceFile:t,sourcePos:0},(function*(){const n=o.parse(e,t);for(const e of n){this._calls.push({type:r.ValueType.integer,data:e.sourcePos});try{let t;if(yield,this._keepDebugInfo)t=e;else{const{type:r,data:n}=e;t={type:r,data:n}}yield*this.eval(t)}finally{this._calls.pop()}}}))}})}}})),System.register("state/types",[],(function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}})),System.register("state/index",["state/parser","state/State","state/types"],(function(e,t){"use strict";t&&t.id;function exportStar_5(t){var r={};for(var n in t)"default"!==n&&(r[n]=t[n]);e(r)}return{setters:[function(e){exportStar_5(e)},function(e){exportStar_5(e)},function(e){exportStar_5(e)}],execute:function(){}}})),System.register("factory",["state/index"],(function(e,t){"use strict";var r;t&&t.id;return e("createState",(function createState(e){return new r.State(e)})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("utf8toansii",["node:fs/promises"],(function(e,t){"use strict";var r;t&&t.id;return{setters:[function(e){r=e}],execute:function(){(async function main(e){const t=(await r.readFile(e)).toString().replace(/[^\r\n\t -~]/g,(e=>`\\u${e.charCodeAt(0).toString(16).padStart(4,"0")}`));await r.writeFile(e,t)})(process.argv[2]).then((()=>console.log("done."))).catch((e=>console.error(e)))}}})),System.register("repl/colors",[],(function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){e("red","\u270ered"),e("green","\u270egreen"),e("yellow","\u270eyellow"),e("blue","\u270eblue"),e("magenta","\u270emagenta"),e("cyan","\u270ecyan"),e("white","\u270ewhite")}}})),System.register("repl/forEach",["repl/colors"],(function(e,t){"use strict";var r;t&&t.id;return e("forEach",(function forEach(e,t){const{length:n}=e;let o=1;n>10&&++o,n>100&&++o;for(let s=0;s<n;++s){const n=`${r.blue}${s.toString().padStart(o," ")}${r.white}`;t(e.at(s),n)}})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("repl/replHost",[],(function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}})),System.register("repl/signals",[],(function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){e("$state",Symbol("state")),e("$debug",Symbol("debug")),e("$load",Symbol("load"))}}})),System.register("repl/host/debug",["repl/signals"],(function(e,t){"use strict";var r;t&&t.id;return e("debug",(function*debug(e){yield r.$debug})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("repl/host/exit",[],(function(e,t){"use strict";var r;t&&t.id;return e("exit",(function*exit(e){throw new r})),{setters:[],execute:function(){r=class ExitError extends Error{},e("ExitError",r)}}})),System.register("repl/host/load",["index","repl/signals"],(function(e,t){"use strict";var r,n;t&&t.id;return e("load",(function*load(e){const{operands:t}=e,[o]=t.check(r.ValueType.string).map((e=>e.data)),s=yield n.$load;if("string"!=typeof s)throw s;t.pop(),yield*e.innerParse(s,o)})),{setters:[function(e){r=e},function(e){n=e}],execute:function(){}}})),System.register("repl/host/state",["repl/signals"],(function(e,t){"use strict";var r;t&&t.id;return e("state",(function*state(e){yield r.$state})),{setters:[function(e){r=e}],execute:function(){}}})),System.register("repl/host/error",[],(function(e,t){"use strict";t&&t.id;return e("error",(function*error(e){throw new Error("JS Error")})),{setters:[],execute:function(){}}})),System.register("repl/host/index",["index","repl/host/debug","repl/host/exit","repl/host/load","repl/host/state","repl/host/error"],(function(e,t){"use strict";var r,n,o,s,a,i,c;t&&t.id;return{setters:[function(e){r=e},function(e){n=e},function(e){o=e},function(e){s=e},function(e){a=e},function(e){i=e}],execute:function(){c={debug:n.debug,exit:o.exit,load:s.load,state:a.state,error:i.error},e("hostDictionary",{get names(){return Object.keys(c)},lookup(e){const t=c[e];return void 0===t?null:{type:r.ValueType.operator,data:t}}})}}})),System.register("repl/status",["repl/colors"],(function(e,t){"use strict";var r,n;t&&t.id;function scaleBytes(e){for(const t of n)if(e>t.factor)return`${(e/t.factor).toFixed(2)}${t.unit}`;return`${e}B`}function memory(e){const{usedMemory:t,totalMemory:n}=e;return n===1/0?scaleBytes(t)+r.blue+"/\u221e"+r.white:scaleBytes(t)+r.blue+"/"+scaleBytes(n)+r.white}return e("memory",memory),e("status",(function status(e,t){let n;n=t.absolute?"cycle: #":"cycles: ";let o="";const{lastOperandsCount:s}=t;if(void 0!==s){const t=e.operands.length;t>s?o=` ${r.red}+${t-s}`:t<s&&(o=` ${r.red}-${s-t}`)}let a="";const{lastUsedMemory:i}=t;if(void 0!==i){const t=e.usedMemory;t>i?a=` ${r.red}+${scaleBytes(t-i)}`:t<i&&(a=` ${r.green}-${scaleBytes(i-t)}`)}return[`${r.cyan}${n}${r.yellow}${t.cycle}`,`${r.cyan}, operands: ${r.yellow}${e.operands.length}${o}`,`${r.cyan}, memory: ${r.yellow}${memory(e)}${a}`,r.white,t.concat,r.white].join("")})),{setters:[function(e){r=e}],execute:function(){n=[{factor:1048576,unit:"MB"},{factor:1024,unit:"kB"}]}}})),System.register("repl/impl",["repl/colors","repl/host/index","factory","repl/host/exit","repl/status","repl/signals","state/callstack","repl/forEach","formatters"],(function(e,t){"use strict";var r,n,o,s,a,i,c,u,l;t&&t.id;return e("main",(async function main(e,t){t&&e.output(`${r.green}DEBUG mode enabled`),e.output(`${r.cyan}Use '${r.yellow}exit${r.cyan}' to quit`),e.output(`${r.cyan}Use '${r.yellow}state${r.cyan}' to print a state summary`);const p=o.createState({hostDictionary:n.hostDictionary,keepDebugInfo:t});let f=0;for(;;){const t=await e.getInput();try{let n=p.operands.length,o=p.usedMemory,s=0,d=!1;const y=p.parse(t,"repl"+f++);let{done:h,value:m}=y.next();for(;!1===h;){let t;if(m===i.$state){const t=p.dictionaries.length;e.output(`${r.cyan}memory: ${r.yellow}${a.memory(p)}`),e.output(`${r.cyan}dictionaries: ${r.yellow}${t}`),u.forEach(p.dictionaries,((t,r)=>{e.output(`${r} ${l.formatters[t.type](t)}`)})),e.output(`${r.cyan}operands: ${r.yellow}${p.operands.length}`),u.forEach(p.operands,((t,n)=>{let o;const{sourceFile:s,sourcePos:a}=t;o=void 0===s||void 0===a?"":` ${r.blue}@${s}(${a.toString()})`,e.output(`${n} ${l.formatters[t.type](t)}${o}`)}))}else if(m===i.$debug)d=!0;else if(m===i.$load){const{data:r}=p.operands.at(0);try{t=await e.getSample(r)}catch(e){t=e}}if(d){e.output(c.renderCallStack(p.calls).replace(/\u00bb.*\u00ab/g,(e=>`${r.yellow}${e}${r.white}`)).replace(/@.*\n/g,(e=>`${r.blue}${e}${r.white}`)).replace(/\/!\\.*\n/g,(e=>`${r.red}${e}${r.white}`)).replace(/\u2026|\u21b5|\u2b72/g,(e=>`${r.blue}${e}${r.white}`))),e.output(a.status(p,{cycle:s,absolute:!0,lastOperandsCount:n,lastUsedMemory:o,concat:`${r.cyan}, ${r.yellow}c${r.cyan}ontinue, ${r.yellow}q${r.cyan}uit`})),n=p.operands.length,o=p.usedMemory;"q"===await e.getChar()&&(d=!1)}++s;const f=y.next(t);h=f.done,m=f.value}e.output(a.status(p,{cycle:s,absolute:!1,lastOperandsCount:n,lastUsedMemory:o}))}catch(t){if(t instanceof s.ExitError)break;if(t instanceof Error){const n=t.toString();e.output(`${r.red}/!\\ ${n}`),t.stack?.split("\n").forEach(((t,o)=>{0===o&&t===n||e.output(`${r.red}${t}`)}))}else e.output(`${r.red}(X) Unknown error`)}}e.output(`${r.red}terminated.`)})),{setters:[function(e){r=e},function(e){n=e},function(e){o=e},function(e){s=e},function(e){a=e},function(e){i=e},function(e){c=e},function(e){u=e},function(e){l=e}],execute:function(){}}}));